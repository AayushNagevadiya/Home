<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Home</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
html,body{
  height:100%;
  margin:0;
  overflow:hidden;
  font-family:system-ui;
}
:root{
  --bg:#f8fafc;--card:#ffffff;--panel:#e0f2fe;--text:#0f172a;
  --btn:#93c5fd;--btnText:#020617;
  --top1:#60a5fa;--top2:#38bdf8;
  --success:#22c55e;--danger:#ef4444;
}
.dark{
  --bg:#020617;--card:#0f172a;--panel:#1e293b;--text:#e5e7eb;
  --btn:#334155;--btnText:#e5e7eb;
}
body{background:var(--bg);color:var(--text)}
.hidden{display:none}

/* LOGIN */
.login{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(135deg,#60a5fa,#38bdf8);
  z-index:100;
}
.login-box{
  background:var(--card);
  padding:40px;border-radius:20px;
  width:90%;max-width:380px;text-align:center
}
.login-box input{
  width:100%;padding:14px;margin:10px 0;
  border-radius:10px;border:1px solid #cbd5f5
}
.login-box button{
  width:100%;padding:14px;border:none;border-radius:12px;
  background:#60a5fa;color:white;font-size:18px
}
#msg{color:#dc2626;font-weight:600}

/* SIDEBAR */
.sidebar{
  position:fixed;top:0;left:0;height:100%;width:240px;
  background:var(--panel);padding:20px;
  transform:translateX(-100%);
  transition:.3s;z-index:20
}
.sidebar.show{transform:translateX(0)}
.sidebar button{
  width:100%;padding:12px;margin:8px 0;
  border:none;border-radius:12px;
  background:var(--btn);color:var(--btnText);
  font-size:16px;text-align:left
}
.toggle{
  margin-top:20px;padding:12px;border-radius:12px;
  background:var(--btn);
  display:flex;justify-content:space-between;align-items:center
}
#overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.4);
  opacity:0;pointer-events:none;
  transition:.3s;z-index:15
}
#overlay.show{opacity:1;pointer-events:auto}

/* APP */
#app{position:fixed; inset:0; z-index:10}
.topbar{
  height:56px;display:flex;align-items:center;
  padding:0 16px;
  background:linear-gradient(135deg,var(--top1),var(--top2));
  color:white
}
.menu{font-size:26px;cursor:pointer}
.topbar h3{flex:1;text-align:center;margin:0}

/* PAGES */
.page{
  position:absolute; inset:56px 0 0 0;
  padding:20px; display:none; overflow-y:auto
}
.page.active{display:block}

/* CARDS */
.card{
  background:var(--card);
  padding:22px;border-radius:20px;
  margin-bottom:20px
}
.master-card{text-align:center;font-weight:700;cursor:pointer}
.master-on{background:#dcfce7;color:#166534}
.master-off{background:#fee2e2;color:#991b1b}
.online{color:var(--success)}
.offline{color:var(--danger)}
.led-vertical{display:flex;flex-direction:column;gap:14px}
.led-btn{
  padding:18px;border:none;border-radius:18px;
  font-size:17px;font-weight:700;
  background:var(--btn);color:var(--btnText)
}

/* VOICE */
.voice-btn{
  width:100%;
  padding:18px;
  border:none;
  border-radius:18px;
  font-size:18px;
  font-weight:700;
  color:white;
  background:#ef4444;
}
.voice-btn.listening{background:#22c55e}
.voice-note{margin-top:10px;font-weight:600}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="login">
  <div class="login-box">
    <h2>Smart Home</h2>
    <input id="name" placeholder="Your Name">
    <input id="phone" placeholder="Enter your number" maxlength="10"
      oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)">
    <button id="loginBtn">Login</button>
    <p id="msg"></p>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <button onclick="navigate('home')">üè† Home</button>
  <button onclick="navigate('room1')">üí° Room 1</button>
  <button onclick="logout()">üö™ Logout</button>
  <div class="toggle">
    <span>üåô Dark Mode</span>
    <input type="checkbox" id="darkToggle">
  </div>
</div>
<div id="overlay"></div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="topbar">
    <span class="menu" onclick="toggleSidebar()">‚ò∞</span>
    <h3 id="pageTitle">Home</h3>
  </div>

  <div class="page active" id="home">
    <div class="card">
      <h2 id="hello"></h2>
      <div id="espStatus">Checking ESP32‚Ä¶</div>
    </div>
    <div class="card master-card master-off" id="masterCard">
      üîí MASTER CONTROL : OFF
    </div>
  </div>

  <div class="page" id="room1">
    <div class="card" id="temp">Temperature: -- ¬∞C</div>

    <div class="card">
      <h3>üé§ Voice Control</h3>
      <button class="voice-btn" id="voiceBtn">üé§ Voice OFF</button>
      <div class="voice-note" id="voiceNote"></div>
    </div>

    <div class="card">
      <div class="led-vertical" id="ledGrid"></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue }
from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const fb=initializeApp({
  apiKey:"AIzaSyAht7TWN8NlbICl0VbEIuc19Mri7oPlXvc",
  databaseURL:"https://home-automation-89830-default-rtdb.firebaseio.com"
});
const db=getDatabase(fb);

/* üîß ADDED (REQUIRED FOR VOICE TO WORK ‚Äì NO FEATURE CHANGE) */
navigator.mediaDevices?.getUserMedia({ audio:true }).catch(()=>{});

const login=document.getElementById("login");
const app=document.getElementById("app");
const loginBtn=document.getElementById("loginBtn");
const nameI=document.getElementById("name");
const phoneI=document.getElementById("phone");
const msg=document.getElementById("msg");
const hello=document.getElementById("hello");
const sidebar=document.getElementById("sidebar");
const overlay=document.getElementById("overlay");
const pageTitle=document.getElementById("pageTitle");
const espStatus=document.getElementById("espStatus");
const temp=document.getElementById("temp");
const ledGrid=document.getElementById("ledGrid");
const masterCard=document.getElementById("masterCard");
const voiceBtn=document.getElementById("voiceBtn");
const voiceNote=document.getElementById("voiceNote");
const darkToggle=document.getElementById("darkToggle");

let masterEnabled=true;

/* LOGIN */
loginBtn.onclick=async()=>{
  const name=nameI.value.trim();
  const phone=phoneI.value.trim();
  msg.innerText="";
  if(name===""||phone.length!==10){
    msg.innerText="Invalid details";return;
  }

  const userRef=ref(db,"visitors/"+phone);
  const snap=await get(userRef);

  set(userRef,{
    name,
    phone,
    blocked:false,
    visits:(snap.exists()?(snap.val().visits||1)+1:1),
    lastVisit:Date.now()
  });

  login.classList.add("hidden");
  login.style.display="none";
  login.style.zIndex="-1";
  app.classList.remove("hidden");
  hello.innerText="Hello, "+name+" üëã";
  navigate("home");
};

/* SIDEBAR */
window.toggleSidebar=()=>{
  sidebar.classList.toggle("show");
  overlay.classList.toggle("show");
};
overlay.onclick=()=>{sidebar.classList.remove("show");overlay.classList.remove("show");};
window.navigate=p=>{
  document.querySelectorAll(".page").forEach(pg=>pg.classList.remove("active"));
  document.getElementById(p).classList.add("active");
  pageTitle.innerText=p==="home"?"Home":"Room 1";
  sidebar.classList.remove("show");
  overlay.classList.remove("show");
};
window.logout=()=>location.reload();

/* ESP STATUS */
setInterval(()=>{
  get(ref(db,"status/lastSeen")).then(s=>{
    espStatus.innerHTML=
      s.exists()&&Date.now()-s.val()<10000
      ?"<span class='online'>‚óè ESP32 ONLINE</span>"
      :"<span class='offline'>‚óè ESP32 OFFLINE</span>";
  });
},1000);

/* TEMP */
onValue(ref(db,"status/temperature"),s=>{
  if(s.exists()) temp.innerText="Temperature: "+s.val()+" ¬∞C";
});

/* MASTER */
onValue(ref(db,"status/masterControl"),s=>{
  masterEnabled=!!s.val();
  masterCard.className="card master-card "+(masterEnabled?"master-on":"master-off");
  masterCard.innerText=masterEnabled?"üîì MASTER CONTROL : ON":"üîí MASTER CONTROL : OFF";
});
masterCard.onclick=()=>set(ref(db,"status/masterControl"),!masterEnabled);

/* LEDS */
const states=[0,0,0,0];
for(let i=1;i<=4;i++){
  const b=document.createElement("button");
  b.className="led-btn";
  b.onclick=()=>{ if(masterEnabled) set(ref(db,"leds/led"+i),!states[i-1]); };
  ledGrid.appendChild(b);
  onValue(ref(db,"leds/led"+i),s=>{
    states[i-1]=!!s.val();
    b.innerText=states[i-1]?"Turn OFF LED "+i:"Turn ON LED "+i;
  });
}

/* VOICE */
voiceBtn.onclick=()=>{
  if(!("webkitSpeechRecognition" in window)){
    voiceNote.innerText="Voice not supported";
    return;
  }

  const rec=new webkitSpeechRecognition();
  rec.lang="en-IN";
  rec.interimResults=false;

  voiceBtn.classList.add("listening");
  voiceBtn.innerText="üé§ Listening...";
  voiceBtn.disabled=true;
  voiceNote.innerText="";

  rec.start();

  rec.onresult=e=>{
    let text=e.results[0][0].transcript.toLowerCase();
    voiceNote.innerText="You said: "+text;

    let cmd=text
      .replace(/\bto\b/g," two ")
      .replace(/\btu\b/g," two ")
      .replace(/\bfor\b/g," four ");

    let led=null;
    if(cmd.match(/\b(one|1)\b/)) led=1;
    else if(cmd.match(/\b(two|2)\b/)) led=2;
    else if(cmd.match(/\b(three|3)\b/)) led=3;
    else if(cmd.match(/\b(four|4)\b/)) led=4;

    if(led!==null){
      if(cmd.includes("on")) set(ref(db,"leds/led"+led),true);
      else if(cmd.includes("off")) set(ref(db,"leds/led"+led),false);
    }
  };

  rec.onend=()=>{
    voiceBtn.classList.remove("listening");
    voiceBtn.innerText="üé§ Voice OFF";
    voiceBtn.disabled=false;
  };
};

/* DARK MODE */
if(localStorage.theme==="dark"){
  document.body.classList.add("dark");
  darkToggle.checked=true;
}
darkToggle.onchange=()=>{
  document.body.classList.toggle("dark");
  localStorage.theme=document.body.classList.contains("dark")?"dark":"light";
};
</script>

</body>
</html>
